<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIC - Stores In Competition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bcg: {
                            green: '#175d40',
                            light: '#1f7a54'
                        }
                    },
                    zIndex: {
                        'map': '0',
                        'footer': '40',
                        'header': '50',
                        'overlay': '60',
                        'sidebar': '3000',
                        'card-base': '10',
                        'card-active': '20'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    },
                    cursor: {
                        'col-resize': 'col-resize',
                    }
                }
            }
        }
    </script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Roboto', 'Noto Sans TC', sans-serif;
            overflow-y: auto; 
            overflow-x: hidden;
            background-color: #f8fafc;
        }
        .dark body { background-color: #0f172a; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; border: 2px solid #f8fafc; }
        .dark ::-webkit-scrollbar-thumb { background-color: #475569; border-color: #0f172a; }

        #map-container { height: 100%; width: 100%; z-index: 1; }

        /* Icons */
        .marker-pin {
            display: flex; justify-content: center; align-items: center;
            color: white; font-size: 14px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
        }
        .marker-target {
            border-radius: 50%; border: 4px solid #fbbf24;
            z-index: 1000 !important; transform: scale(1.2);
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.6);
        }
        .marker-standard { border-radius: 50%; border: 2px solid white; }

        .marker-competitor-wrap {
            position: relative; width: 0; height: 0;
            border-left: 20px solid transparent; border-right: 20px solid transparent;
            border-bottom: 34px solid #f87171;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.3));
            display: flex; justify-content: center;
        }
        .marker-competitor-brand-badge {
            position: absolute; top: -10px; left: -8px;
            background: white; border-radius: 50%; padding: 1px;
            width: 16px; height: 16px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .marker-competitor-icon {
            position: absolute; top: 16px; left: -8px;
            color: white; font-size: 12px; width: 16px;
            text-align: center; z-index: 2;
        }

        /* Flip Card Utilities */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- Initial Config ---
        const DEFAULT_BRANDS = ["全聯", "萊爾富", "7-ELEVEN", "FamilyMart"];
        
        // --- Helper Functions ---

        const parseAddress = (addr) => {
            if (!addr) return { city: "", district: "", road: "", zip: "" };
            let cleanAddr = addr.toString().replace(/\s+/g, '').replace(/^(台灣省|臺灣省|台灣|臺灣)/, '').trim();
            const zipMatch = cleanAddr.match(/^(\d{3,5})/);
            const zip = zipMatch ? zipMatch[1] : "";
            if (zip) cleanAddr = cleanAddr.substring(zip.length);
            const cityMatch = cleanAddr.match(/^(.{2,3}[縣市])/);
            const city = cityMatch ? cityMatch[1] : "";
            let remaining = city ? cleanAddr.substring(cleanAddr.indexOf(city) + city.length) : cleanAddr;
            const distMatch = remaining.match(/^(.+?[鄉鎮市區])/);
            const district = distMatch ? distMatch[1] : "";
            remaining = district ? remaining.substring(remaining.indexOf(district) + district.length) : remaining;
            const roadMatch = remaining.match(/^(.+?[路街道]([一二三四五六七八九十]+段)?)/);
            const road = roadMatch ? roadMatch[1] : "";
            return { city, district, road, zip };
        };

        const normalizeBrand = (rawName, storeName = "") => {
            let n = (rawName || "").trim();
            const combined = (n + " " + (storeName || "")).toLowerCase();
            if (combined.includes("統一") || combined.includes("7-11") || combined.includes("seven") || combined.includes("ibon")) return "7-ELEVEN";
            if (combined.includes("全家") || combined.includes("family")) return "FamilyMart";
            if (combined.includes("萊爾富") || combined.includes("hi-life")) return "萊爾富";
            if (combined.includes("全聯") || combined.includes("px")) return "全聯";
            n = n.replace(/股份有限公司|有限公司|實業/g, "");
            return n.trim() || "其他";
        };

        const createStore = (id, brand, brand_en, name_tw, name_en, addr_tw, addr_en, city_tw, city_en, dist_tw, dist_en, zip, lat, lng, phone) => ({
            id, brand, brand_en, 
            name: { tw: name_tw, en: name_en },
            address: { tw: addr_tw, en: addr_en },
            city: { tw: city_tw, en: city_en },
            district: { tw: dist_tw, en: dist_en },
            road: parseAddress(addr_tw).road,
            zip: zip || parseAddress(addr_tw).zip, 
            lat, lng, phone
        });

        // Initial Mock Data
        const MOCK_DATA = [
            createStore(1, "全聯", "PX Mart", "台中三厝店", "Taichung Sancuo Store", "408台中市南屯區三厝街100號", "No. 100, Sancuo St., Nantun Dist., Taichung City", "台中市", "Taichung City", "南屯區", "Nantun Dist.", "408", 24.148, 120.635, "04-2380-1234"),
            createStore(4, "全聯", "PX Mart", "台北信義店", "Taipei Xinyi Store", "110台北市信義區信義路五段", "Sec. 5, Xinyi Rd., Xinyi Dist., Taipei City", "台北市", "Taipei City", "信義區", "Xinyi Dist.", "110", 25.033, 121.564, "02-2720-0000"),
            createStore(5, "萊爾富", "Hi-Life", "台北松壽店", "Taipei Songshou Store", "台北市信義區松壽路", "Songshou Rd., Xinyi Dist., Taipei City", "台北市", "Taipei City", "信義區", "Xinyi Dist.", "110", 25.036, 121.568, "02-2722-1111"),
            createStore(10, "FamilyMart", "FamilyMart", "台北101店", "Taipei 101 Store", "台北市信義區市府路45號", "No. 45, Shifu Rd., Xinyi Dist., Taipei City", "台北市", "Taipei City", "信義區", "Xinyi Dist.", "110", 25.034, 121.565, "02-8101-0000"),
        ];

        const BRAND_LINKS = {
            "全聯": "https://www.pxmart.com.tw/#/shopList",
            "萊爾富": "https://www.hilife.com.tw/storeInquiry_street.aspx",
            "7-ELEVEN": "https://emap.pcsc.com.tw/",
            "FamilyMart": "https://www.family.com.tw/marketing/inquiry.aspx"
        };

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; const φ1 = lat1 * Math.PI/180; const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180; const Δλ = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        const i18n = {
            tw: {
                slogan_main: "Stores In Competition", slogan_sub: "好店比拚, 盡在眼前",
                searchTitle: "條件搜尋", city: "縣市", district: "鄉鎮市區", zip: "郵遞區號 (選填)", road: "路名 (選填)",
                storeName: "門店名稱", selectStore: "請選擇門店...", brand: "門店品牌", selectAll: "全選", reset: "重置",
                targetStore: "目標門店", competitors: "周邊競店", radius: "競店範圍", analyzing: "分析中...", meters: "公尺",
                links_title: "門市資訊-官網查詢", toggle_map: "地圖位置區", toggle_info: "門店資訊區", select_comp: "請選擇競爭店家",
                creator: "Prof. Shihmin Lo, PhD", copyright: "© 2025 SIC All Rights Reserved.", noStoreInArea: "該區域無符合條件的門店",
                select_comp_default: "選擇競店", radius_50: "50公尺", radius_100: "100公尺", radius_500: "500公尺",
                none: "無", import_csv: "匯入 CSV", import_desc: "支援：公司名稱, 地址, 緯度, 經度", processing: "處理中...",
                flip1_title: "同品牌競合", flip1_content: "市場切割（不同動線、不同時段客群）+ 防禦策略（卡位、阻擋競爭者進入）",
                flip2_title: "異品牌競爭", flip2_content: "距離越近，價格、商品、活動、服務的競爭越激烈",
                sci_title: "相同品牌競合態勢 (SCI)", cci_title: "不同品牌競爭強度 (CCI)",
                too_many: "請先篩選區域以顯示店名", select_all_opt: "全部", encoding: "編碼"
            },
            en: {
                slogan_main: "Stores In Competition", slogan_sub: "好店比拚, 盡在眼前",
                searchTitle: "Search Filters", city: "City", district: "District", zip: "Zip Code (Opt)", road: "Road (Opt)",
                storeName: "Store Name", selectStore: "Select a store...", brand: "Brand", selectAll: "Select All", reset: "Reset",
                targetStore: "Target Store", competitors: "Competitors", radius: "Comp. Radius", analyzing: "Analyzing...", meters: "m",
                links_title: "Official Store Locators", toggle_map: "Map Area", toggle_info: "Info Area", select_comp: "Select Competitor",
                creator: "Prof. Shihmin Lo, PhD", copyright: "© 2025 SIC All Rights Reserved.", noStoreInArea: "No stores found in area",
                select_comp_default: "Select Comp", radius_50: "50m", radius_100: "100m", radius_500: "500m",
                none: "None", import_csv: "Import CSV", import_desc: "Supports: Name, Address, Lat, Lng", processing: "Processing...",
                flip1_title: "Same-Brand Co-opetition", flip1_content: "Market Segmentation + Defensive Strategy",
                flip2_title: "Cross-Brand Competition", flip2_content: "Closer distance means fiercer competition.",
                sci_title: "Same Brand Comp Index (SCI)", cci_title: "Cross Brand Comp Index (CCI)",
                too_many: "Filter by city to list stores", select_all_opt: "All", encoding: "Encoding"
            }
        };

        const BrandIcon = ({ brand, size = "md" }) => {
            const sizeClass = size === "sm" ? "w-4 h-4 text-[8px]" : "w-6 h-6 text-xs";
            let icon = "fa-store"; let colorClass = "text-green-600 bg-green-50"; let borderClass = "border-green-200";
            const b = (brand || "").toLowerCase();
            if (b.includes("全聯") || b.includes("px")) { icon = "fa-shopping-basket"; colorClass = "text-blue-600 bg-blue-50"; borderClass = "border-blue-200"; }
            else if (b.includes("萊爾富") || b.includes("hi-life")) { icon = "fa-heart"; colorClass = "text-pink-500 bg-pink-50"; borderClass = "border-pink-200"; }
            else if (b.includes("7-eleven") || b.includes("7-11") || b.includes("seven")) { icon = "fa-7"; colorClass = "text-orange-500 bg-orange-50"; borderClass = "border-orange-200"; }
            else if (b.includes("全家") || b.includes("family")) { icon = "fa-f"; colorClass = "text-green-600 bg-green-50"; borderClass = "border-green-200"; }
            return <div className={`${sizeClass} rounded-full flex items-center justify-center border ${borderClass} ${colorClass} shrink-0`}>{b.includes("7-eleven") || b.includes("7-11") ? <span className="font-bold">7</span> : (b.includes("全家") || b.includes("family") ? <span className="font-bold">F</span> : <i className={`fas ${icon}`}></i>)}</div>;
        };

        // --- Components ---
        const Header = ({ lang, setLang, theme, setTheme, onToggleSidebar, layout, toggleLayout }) => {
            const t = i18n[lang];
            return (
                <header className="h-16 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-4 fixed top-0 left-0 w-full z-header shadow-sm select-none">
                    <div className="flex items-center gap-3 lg:gap-6">
                        <button onClick={onToggleSidebar} className="text-slate-600 dark:text-slate-300 hover:text-bcg-green p-2 rounded transition-colors focus:outline-none"><i className="fas fa-bars text-xl"></i></button>
                        <div className="flex items-center gap-3 cursor-pointer group" onClick={() => { window.scrollTo(0,0); }}>
                            <div className="w-10 h-10 bg-bcg-green rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-md group-hover:bg-emerald-600 transition-colors">SIC</div>
                            <div className="flex flex-col hidden md:flex"><h1 className="text-base lg:text-lg font-bold text-slate-800 dark:text-white leading-none mb-0.5 font-sans tracking-wide truncate max-w-[120px] lg:max-w-none">{t.slogan_main}</h1><p className="text-[10px] lg:text-xs text-slate-500 dark:text-slate-400 font-medium tracking-wider">{t.slogan_sub}</p></div>
                        </div>
                    </div>
                    <div className="flex items-center gap-2 absolute left-1/2 transform -translate-x-1/2">
                        <button onClick={() => toggleLayout('map')} title={t.toggle_map} className={`w-8 h-8 rounded-full flex items-center justify-center transition-all shadow-sm ${layout.map ? 'bg-bcg-green text-white scale-110 ring-2 ring-emerald-100' : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}`}><i className="fas fa-map-marked-alt text-sm"></i></button>
                        <button onClick={() => toggleLayout('info')} title={t.toggle_info} className={`w-8 h-8 rounded-full flex items-center justify-center transition-all shadow-sm ${layout.info ? 'bg-bcg-green text-white scale-110 ring-2 ring-emerald-100' : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}`}><i className="fas fa-info-circle text-sm"></i></button>
                    </div>
                    <div className="flex items-center gap-2 lg:gap-4">
                        <div className="flex border border-slate-300 dark:border-slate-600 rounded overflow-hidden text-xs font-bold"><button onClick={() => setLang('tw')} className={`px-2 py-1 ${lang === 'tw' ? 'bg-bcg-green text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-500'}`}>繁</button><button onClick={() => setLang('en')} className={`px-2 py-1 ${lang === 'en' ? 'bg-bcg-green text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-500'}`}>EN</button></div>
                        <button onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')} className="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-600 dark:text-yellow-400"><i className={`fas ${theme === 'light' ? 'fa-moon' : 'fa-sun'}`}></i></button>
                    </div>
                </header>
            );
        };

        const Sidebar = ({ isOpen, width, onResizeStart, closeSidebar, lang, filters, setFilters, resetFilters, matchingStores, onSelectStore, onImportData, cities, districtsMap, roadsMap, zipsMap, availableBrands }) => {
            const t = i18n[lang];
            const fileInputRef = useRef(null);
            const [encoding, setEncoding] = useState("Big5");
            
            const handleBrandChange = (brand) => setFilters(prev => ({ ...prev, brands: prev.brands.includes(brand) ? prev.brands.filter(b => b !== brand) : [...prev.brands, brand] }));
            const toggleAllBrands = () => setFilters(prev => ({ ...prev, brands: filters.brands.length === availableBrands.length ? [] : [...availableBrands] }));
            const handleInputChange = (e) => setFilters(prev => ({ ...prev, [e.target.name]: e.target.value }));
            const displayStoreName = (store) => lang === 'en' ? store.name.en : store.name.tw;
            
            const currentDistricts = filters.city ? (districtsMap[filters.city] || []).sort() : [];
            const currentRoads = useMemo(() => {
                let roads = new Set();
                const cityKey = filters.city || "";
                const distKey = filters.district || "";
                if (distKey) {
                    roads = new Set(roadsMap[cityKey + distKey] || []);
                } else if (cityKey) {
                    Object.keys(roadsMap).forEach(key => { if (key.startsWith(cityKey)) roadsMap[key].forEach(r => roads.add(r)); });
                }
                return [...roads].sort();
            }, [filters.city, filters.district, roadsMap]);

            const currentZips = useMemo(() => {
                let zips = new Set();
                const cityKey = filters.city || "";
                const distKey = filters.district || "";
                if (distKey) {
                    zips = new Set(zipsMap[cityKey + distKey] || []);
                } else if (cityKey) {
                    Object.keys(zipsMap).forEach(key => { if (key.startsWith(cityKey)) zipsMap[key].forEach(z => zips.add(z)); });
                }
                return [...zips].sort();
            }, [filters.city, filters.district, zipsMap]);

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) { onImportData(file, encoding); e.target.value = null; }
            };

            return (
                <>
                    <aside 
                        className={`fixed left-0 top-16 bottom-0 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-700 shadow-2xl z-sidebar overflow-hidden transition-transform duration-300 ease-in-out lg:transition-none select-none`}
                        style={{ width: window.innerWidth >= 1024 ? width : '70vw', maxWidth: window.innerWidth >= 1024 ? 'none' : '280px', transform: isOpen ? 'translateX(0)' : 'translateX(-100%)' }}
                    >
                        <div className="hidden lg:block absolute right-0 top-0 bottom-0 w-1 cursor-col-resize hover:bg-bcg-green/50 transition-colors z-50" onMouseDown={onResizeStart}></div>
                        <div className="h-full overflow-y-auto p-6 space-y-6">
                            <div className="flex items-center justify-between border-b pb-3 dark:border-slate-700">
                                <h2 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><i className="fas fa-filter text-bcg-green"></i> {t.searchTitle}</h2>
                                <button onClick={resetFilters} className="text-xs text-slate-500 hover:text-red-500 underline"><i className="fas fa-undo"></i> {t.reset}</button>
                            </div>
                            
                            <div className="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg border border-dashed border-slate-300 dark:border-slate-600">
                                <div className="flex items-center justify-between mb-2">
                                    <span className="text-xs text-slate-500">{t.encoding}</span>
                                    <select value={encoding} onChange={(e) => setEncoding(e.target.value)} className="text-xs bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded px-2 py-1 cursor-pointer">
                                        <option value="Big5">Big5</option>
                                        <option value="UTF-8">UTF-8</option>
                                    </select>
                                </div>
                                <input type="file" accept=".csv" ref={fileInputRef} onChange={handleFileChange} className="hidden" />
                                <button onClick={() => fileInputRef.current.click()} className="w-full py-2 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded text-sm text-slate-600 dark:text-slate-300 hover:bg-bcg-green hover:text-white transition-colors flex items-center justify-center gap-2"><i className="fas fa-file-upload"></i> {t.import_csv}</button>
                                <p className="text-[10px] text-center text-slate-400 mt-1">{t.import_desc}</p>
                            </div>

                            <div>
                                <div className="flex justify-between items-center mb-2"><label className="text-xs font-bold text-slate-500 uppercase tracking-wider">{t.brand}</label><button onClick={toggleAllBrands} className="text-[10px] text-blue-500 hover:underline">{t.selectAll}</button></div>
                                <div className="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto custom-scrollbar">
                                    {availableBrands.map(brand => (
                                        <label key={brand} className={`flex items-center gap-2 p-2 rounded border cursor-pointer transition-all ${filters.brands.includes(brand) ? 'bg-blue-50 border-blue-200' : 'bg-slate-50 border-transparent'}`}>
                                            <input type="checkbox" checked={filters.brands.includes(brand)} onChange={() => handleBrandChange(brand)} className="accent-bcg-green shrink-0" />
                                            <BrandIcon brand={brand} size="sm" />
                                            <span className="text-xs text-slate-700 truncate" title={brand}>{brand}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>
                            <div className="space-y-3">
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">{t.city}</label><select name="city" value={filters.city} onChange={handleInputChange} className="w-full p-2 rounded-lg bg-slate-100 dark:bg-slate-800 border-none outline-none text-sm cursor-pointer"><option value="">{t.select_all_opt}</option>{cities.map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">{t.district}</label><select name="district" value={filters.district} onChange={handleInputChange} className="w-full p-2 rounded-lg bg-slate-100 dark:bg-slate-800 border-none outline-none text-sm cursor-pointer" disabled={!filters.city}><option value="">{t.select_all_opt}</option>{currentDistricts.map(d => <option key={d} value={d}>{d}</option>)}</select></div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">{t.zip}</label><select name="zip" value={filters.zip} onChange={handleInputChange} className="w-full p-2 rounded-lg bg-slate-100 dark:bg-slate-800 border-none outline-none text-sm cursor-pointer"><option value="">{t.select_all_opt}</option>{currentZips.map(z => <option key={z} value={z}>{z}</option>)}</select></div>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">{t.road}</label><select name="road" value={filters.road} onChange={handleInputChange} className="w-full p-2 rounded-lg bg-slate-100 dark:bg-slate-800 border-none outline-none text-sm cursor-pointer"><option value="">{t.select_all_opt}</option>{currentRoads.map(r => <option key={r} value={r}>{r}</option>)}</select></div>
                                </div>
                            </div>
                            <div className="pt-2 border-t dark:border-slate-700">
                                <label className="block text-xs font-bold text-slate-800 dark:text-white mb-2">{t.storeName}</label>
                                <select className="w-full p-3 rounded-lg border-2 border-bcg-green/20 bg-white dark:bg-slate-800 text-slate-800 dark:text-white outline-none focus:border-bcg-green cursor-pointer" onChange={(e) => { if (e.target.value) onSelectStore(parseInt(e.target.value)); }} value="">
                                    <option value="">{matchingStores.length > 200 && !filters.city ? t.too_many : (matchingStores.length > 0 ? t.selectStore : t.noStoreInArea)}</option>
                                    {(matchingStores.length <= 200 || filters.city) && matchingStores.slice(0, 500).map(store => <option key={store.id} value={store.id}>{store.brand} - {displayStoreName(store)}</option>)}
                                </select>
                            </div>
                        </div>
                    </aside>
                    <div className={`lg:hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[2999] transition-opacity duration-300 ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={closeSidebar} />
                </>
            );
        };

        const StoreDetail = ({ store, isTarget, lang }) => {
            const name = lang === 'en' ? store.name.en : store.name.tw;
            const address = lang === 'en' ? store.address.en : store.address.tw;
            const brand = lang === 'en' ? store.brand_en : store.brand;
            return (
                <div className={`p-4 rounded-lg border shadow-sm transition-colors text-left w-full ${isTarget ? 'bg-emerald-50 dark:bg-emerald-900/20 border-emerald-200 dark:border-emerald-800' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700'}`}>
                    <div className="flex items-center gap-2 mb-2 pb-2 border-b border-slate-200 dark:border-slate-700/50">
                        <BrandIcon brand={store.brand} />
                        <div><h2 className="text-base font-bold text-slate-800 dark:text-white leading-tight">{brand}</h2><p className="text-sm text-slate-500 dark:text-slate-400 font-medium">{name}</p></div>
                    </div>
                    <div className="space-y-1.5 text-xs text-slate-600 dark:text-slate-300">
                        <div className="flex gap-2"><i className={`fas fa-map-marker-alt mt-0.5 w-3 text-center ${isTarget ? 'text-bcg-green' : 'text-slate-400'}`}></i><span className="leading-relaxed">{address}</span></div>
                        <div className="flex gap-2"><i className={`fas fa-phone mt-0.5 w-3 text-center ${isTarget ? 'text-bcg-green' : 'text-slate-400'}`}></i><span>{store.phone || "N/A"}</span></div>
                        {!isTarget && store.distance && <div className="flex gap-2 pt-1"><span className="bg-red-100 text-red-600 dark:bg-red-900/40 dark:text-red-300 px-1.5 py-0.5 rounded font-bold">{Math.round(store.distance)}m</span></div>}
                    </div>
                </div>
            );
        };

        const FlipCard = ({ title, content }) => {
            const [flipped, setFlipped] = useState(false);
            return (
                <div className="group h-32 w-full perspective-1000 cursor-pointer" onClick={() => setFlipped(!flipped)}>
                    <div className={`relative h-full w-full transition-all duration-500 transform-style-3d ${flipped ? 'rotate-y-180' : ''}`}>
                        <div className="absolute inset-0 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-4 flex flex-col items-center justify-center backface-hidden shadow-sm">
                            <h4 className="font-bold text-bcg-green text-center">{title}</h4>
                            <div className="mt-2 text-bcg-green/50"><i className="fas fa-sync-alt"></i></div>
                        </div>
                        <div className="absolute inset-0 bg-bcg-green text-white rounded-lg p-4 flex items-center justify-center backface-hidden rotate-y-180 shadow-md">
                            <p className="text-xs text-center leading-relaxed font-medium">{content}</p>
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ sci, cci, t }) => {
            const getMax = (val) => Math.min(val * 10, 100); 
            return (
                <div className="mt-4 p-4 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 shadow-sm space-y-4">
                    <div><div className="flex justify-between text-xs mb-1"><span className="font-bold text-slate-600 dark:text-slate-300">{t.sci_title}</span><span className="font-mono font-bold text-blue-600">{sci}</span></div><div className="h-3 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden"><div className="h-full bg-gradient-to-r from-blue-300 to-blue-600 transition-all duration-500" style={{width: `${getMax(sci)}%`}}></div></div></div>
                    <div><div className="flex justify-between text-xs mb-1"><span className="font-bold text-slate-600 dark:text-slate-300">{t.cci_title}</span><span className="font-mono font-bold text-red-600">{cci}</span></div><div className="h-3 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden"><div className="h-full bg-gradient-to-r from-red-300 to-red-600 transition-all duration-500" style={{width: `${getMax(cci)}%`}}></div></div></div>
                </div>
            );
        };

        const MapArea = ({ displayData, centerStore, onStoreSelect, onMapMoveEnd, compRadius, lang }) => {
            const mapRef = useRef(null);
            const markersRef = useRef({}); 
            
            const getBrandIconHtml = (brand, isTarget, color) => {
                let inner = "";
                const b = (brand || "").toLowerCase();
                if (b.includes("7-eleven") || b.includes("7-11")) inner = `<span class="font-bold text-xs">7</span>`;
                else if (b.includes("全家") || b.includes("family")) inner = `<span class="font-bold text-xs">F</span>`;
                else {
                    let iconClass = "fa-store";
                    if (b.includes("全聯") || b.includes("px")) iconClass = "fa-shopping-basket";
                    if (b.includes("萊爾富") || b.includes("hi-life")) iconClass = "fa-heart";
                    inner = `<i class="fas ${iconClass} text-[10px]"></i>`;
                }
                return isTarget ? `<div class="marker-pin marker-target" style="background-color: ${color}; width: 36px; height: 36px;">${inner}</div>` : `<div class="marker-competitor-wrap"><div class="marker-competitor-brand-badge text-slate-800">${inner}</div><i class="fas fa-store marker-competitor-icon"></i></div>`;
            };

            useEffect(() => {
                if (!mapRef.current) {
                    const map = L.map('map-container', { zoomControl: false }).setView([24.148, 120.635], 15);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap', maxZoom: 20 }).addTo(map);
                    L.control.zoom({ position: 'bottomright' }).addTo(map);
                    L.control.scale({ position: 'bottomright', imperial: true }).addTo(map);
                    map.on('moveend', () => setTimeout(() => onMapMoveEnd && onMapMoveEnd(map.getCenter(), map.getZoom()), 500));
                    mapRef.current = map;
                }
            }, []);
            useEffect(() => {
                if(mapRef.current && centerStore) {
                    let zoom = 16;
                    if (compRadius <= 50) zoom = 18; else if (compRadius <= 100) zoom = 17; else if (compRadius >= 500) zoom = 15;
                    mapRef.current.flyTo([centerStore.lat, centerStore.lng], zoom, { animate: true, duration: 0.8 });
                }
            }, [centerStore, compRadius]);
            useEffect(() => {
                const map = mapRef.current;
                if (!map) return;
                Object.values(markersRef.current).forEach(m => map.removeLayer(m));
                markersRef.current = {};
                displayData.forEach(store => {
                    const isCenter = centerStore && store.id === centerStore.id;
                    let color = '#16a34a'; 
                    const b = (store.brand || "").toLowerCase();
                    if(b.includes("全聯") || b.includes("px")) color = '#0055aa'; 
                    if(b.includes("萊爾富") || b.includes("hi-life")) color = '#e91e63'; 
                    if(b.includes("7-eleven") || b.includes("7-11")) color = '#f97316';
                    
                    const html = getBrandIconHtml(store.brand, isCenter, color);
                    const icon = L.divIcon({ className: 'custom-div-icon', html: html, iconSize: isCenter ? [40, 40] : [40, 34], iconAnchor: isCenter ? [20, 20] : [20, 34] });
                    const marker = L.marker([store.lat, store.lng], { icon, zIndexOffset: isCenter ? 1000 : 0 }).addTo(map);
                    marker.on('click', () => onStoreSelect(store));
                    markersRef.current[store.id] = marker;
                });
            }, [displayData, centerStore]);
            return <div id="map-container" className="h-full w-full bg-slate-100 rounded-lg shadow-inner"></div>;
        };

        const Footer = ({ t }) => {
            const versionDate = new Date().toLocaleDateString();
            return (
                <footer className="bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700 w-full p-4 mt-8">
                    <div className="flex flex-col md:flex-row justify-between items-center text-[10px] text-slate-500 dark:text-slate-400 max-w-7xl mx-auto px-2 gap-4 md:gap-0">
                        <div className="flex flex-col gap-0.5 text-center md:text-left order-2 md:order-1"><span>Ver. {versionDate}</span><span>{t.copyright}</span></div>
                        <div className="flex gap-2 order-1 md:order-2">{Object.entries(BRAND_LINKS).map(([brand, url]) => (<a key={brand} href={url} target="_blank" rel="noopener noreferrer" className="w-6 h-6 rounded-full bg-slate-50 border border-slate-200 flex items-center justify-center text-slate-600 hover:border-bcg-green hover:text-bcg-green transition-all" title={brand}><BrandIcon brand={brand} size="sm" /></a>))}</div>
                        <div className="flex flex-col items-center md:items-end gap-0.5 text-right order-3"><a href="https://www.ibs.ncnu.edu.tw/index.php/faculty/tenured-professor/299-smlo" target="_blank" className="font-bold text-slate-700 dark:text-slate-300 hover:text-bcg-green">{t.creator}</a><div className="flex gap-2 text-[9px] text-slate-400"><a href="https://www.ibs.ncnu.edu.tw/" target="_blank" className="hover:underline">IBS</a><span>|</span><a href="https://rpage.ncnu.edu.tw/" target="_blank" className="hover:underline">NCNU</a></div></div>
                    </div>
                </footer>
            );
        };

        const App = () => {
            const [lang, setLang] = useState('tw');
            const [theme, setTheme] = useState('light');
            const [isSidebarOpen, setSidebarOpen] = useState(true);
            const [sidebarWidth, setSidebarWidth] = useState(320);
            const [layout, setLayout] = useState({ map: true, info: true });
            
            const [allStores, setAllStores] = useState(MOCK_DATA); 
            const [filters, setFilters] = useState({ brands: [...DEFAULT_BRANDS], city: "", district: "", zip: "", road: "" });
            const [centerStore, setCenterStore] = useState(null);
            const [compRadius, setCompRadius] = useState(500);
            const [competitors, setCompetitors] = useState([]);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [selectedCompId, setSelectedCompId] = useState("");
            const [indices, setIndices] = useState({ sci: 0, cci: 0 });

            const resizingRef = useRef(false);
            const handleResizeStart = (e) => { resizingRef.current = true; document.body.style.cursor = 'col-resize'; document.addEventListener('mousemove', handleResizeMove); document.addEventListener('mouseup', handleResizeEnd); };
            const handleResizeMove = (e) => { if (!resizingRef.current) return; const newWidth = e.clientX; const minWidth = window.innerWidth * 0.2; const maxWidth = window.innerWidth * 0.33; if (newWidth >= minWidth && newWidth <= maxWidth) setSidebarWidth(newWidth); };
            const handleResizeEnd = () => { resizingRef.current = false; document.body.style.cursor = 'default'; document.removeEventListener('mousemove', handleResizeMove); document.removeEventListener('mouseup', handleResizeEnd); };

            useEffect(() => { document.documentElement.classList.toggle('dark', theme === 'dark'); }, [theme]);
            
            const availableBrands = useMemo(() => [...new Set(allStores.map(s => s.brand))].sort(), [allStores]);
            const dynamicCities = useMemo(() => [...new Set(allStores.map(s => s.city[lang === 'en' ? 'en' : 'tw']).filter(Boolean))].sort(), [allStores, lang]);
            
            const dynamicDistrictsMap = useMemo(() => {
                const map = {};
                const key = lang === 'en' ? 'en' : 'tw';
                allStores.forEach(s => {
                    const c = s.city[key]; const d = s.district[key];
                    if (c) { if (!map[c]) map[c] = []; if (d && !map[c].includes(d)) map[c].push(d); }
                });
                return map;
            }, [allStores, lang]);

            const dynamicRoadsMap = useMemo(() => {
                const map = {};
                const key = lang === 'en' ? 'en' : 'tw';
                allStores.forEach(s => {
                    const k = s.city[key] + s.district[key];
                    if (s.road) { if (!map[k]) map[k] = []; if (!map[k].includes(s.road)) map[k].push(s.road); }
                });
                return map;
            }, [allStores, lang]);

            const dynamicZipsMap = useMemo(() => {
                const map = {};
                const key = lang === 'en' ? 'en' : 'tw';
                allStores.forEach(s => {
                    const k = s.city[key] + s.district[key];
                    if (s.zip) { if (!map[k]) map[k] = []; if (!map[k].includes(s.zip)) map[k].push(s.zip); }
                });
                return map;
            }, [allStores, lang]);

            useEffect(() => { if (allStores.length > 0 && !centerStore) setCenterStore(allStores[0]); }, [allStores]);

            const matchingStores = useMemo(() => allStores.filter(store => {
                if (filters.brands.length > 0 && !filters.brands.includes(store.brand)) return false;
                const key = lang === 'en' ? 'en' : 'tw';
                if (filters.city && store.city[key] !== filters.city) return false; 
                if (filters.district && store.district[key] !== filters.district) return false; 
                if (filters.zip && store.zip !== filters.zip) return false;
                if (filters.road && store.road !== filters.road) return false; 
                return true;
            }).sort((a,b) => a.brand.localeCompare(b.brand)), [filters, allStores, lang]);

            const handleImportData = (file, encoding) => {
                setIsAnalyzing(true);
                Papa.parse(file, {
                    header: true, skipEmptyLines: true, encoding: encoding,
                    complete: (results) => {
                        const headers = results.meta.fields.map(h => h.trim());
                        const findCol = (keywords) => headers.find(h => keywords.some(k => h.toLowerCase().includes(k.toLowerCase())));
                        const colLat = findCol(['緯度', 'lat', 'latitude']);
                        const colLng = findCol(['經度', 'lng', 'longitude']);
                        const colAddr = findCol(['分公司地址', '地址', 'address', 'addr', 'location', '住址']);
                        const colBrand = findCol(['公司名稱', '品牌', 'brand', 'company', '商號', '名稱', '據點', '商店', '店家', '站名']);
                        const colName = findCol(['分公司名稱', '店名', 'name', 'store', '門市', 'title']) || colBrand; 
                        const colPhone = findCol(['電話', 'phone', 'tel']);

                        if (!colLat || !colLng) { alert("匯入失敗：CSV 必須包含「緯度」與「經度」欄位。"); setIsAnalyzing(false); return; }

                        const newStores = results.data.filter(row => row[colLat] && row[colLng]).map((row, idx) => {
                            const rawBrand = row[colBrand] || "";
                            const rawName = row[colName] || "";
                            const niceBrand = normalizeBrand(rawBrand, rawName);
                            const address = row[colAddr] || "";
                            const parsed = parseAddress(address);
                            return {
                                id: 2000 + idx, brand: niceBrand || rawBrand || "其他", brand_en: niceBrand || rawBrand || "Other",
                                name: { tw: rawName || niceBrand, en: rawName || niceBrand },
                                address: { tw: address, en: address },
                                city: { tw: parsed.city, en: parsed.city },
                                district: { tw: parsed.district, en: parsed.district },
                                road: parsed.road, zip: parsed.zip,
                                lat: parseFloat(row[colLat]), lng: parseFloat(row[colLng]), phone: row[colPhone] || ""
                            };
                        });
                        
                        if (newStores.length > 0) {
                            setAllStores(newStores);
                            const newBrands = [...new Set(newStores.map(s => s.brand))];
                            setFilters(prev => ({ ...prev, brands: newBrands })); // Preserve other filters
                            alert(`成功匯入 ${newStores.length} 筆資料`);
                        } else { alert("無法解析資料"); }
                        setIsAnalyzing(false);
                    },
                    error: (err) => { alert("匯入錯誤: " + err.message); setIsAnalyzing(false); }
                });
            };

            useEffect(() => {
                if (!centerStore) { setCompetitors([]); setIndices({sci:0, cci:0}); setSelectedCompId(""); return; }
                setIsAnalyzing(true);
                setTimeout(() => {
                    const comps = []; let sciSum = 0, cciSum = 0;
                    allStores.forEach(store => {
                        if (store.id === centerStore.id) return;
                        const dist = getDistance(centerStore.lat, centerStore.lng, store.lat, store.lng);
                        if (dist <= compRadius) {
                            comps.push({ ...store, distance: dist });
                            const safeDist = Math.max(dist, 2);
                            const score = 1 / Math.log10(safeDist);
                            if (store.brand === centerStore.brand) sciSum += score; else cciSum += score;
                        }
                    });
                    comps.sort((a, b) => a.distance - b.distance);
                    setCompetitors(comps);
                    setIndices({ sci: sciSum.toFixed(1), cci: cciSum.toFixed(1) });
                    if (comps.length > 0) setSelectedCompId(comps[0].id.toString()); else setSelectedCompId("");
                    setIsAnalyzing(false);
                }, 500);
            }, [centerStore, compRadius, allStores]);

            const displayData = useMemo(() => centerStore ? [centerStore, ...competitors] : [], [centerStore, competitors]);
            const t = i18n[lang];
            const mainStyle = { paddingLeft: window.innerWidth >= 1024 && isSidebarOpen ? `${sidebarWidth}px` : '0', transition: 'padding-left 0.3s ease-in-out' };

            return (
                <div className="flex flex-col min-h-screen">
                    <Header lang={lang} setLang={setLang} theme={theme} setTheme={setTheme} onToggleSidebar={() => setSidebarOpen(prev => !prev)} layout={layout} toggleLayout={(k) => setLayout(p => ({...p, [k]: !p[k]}))} />
                    <Sidebar 
                        isOpen={isSidebarOpen} width={sidebarWidth} onResizeStart={handleResizeStart} closeSidebar={() => setSidebarOpen(false)} 
                        lang={lang} filters={filters} setFilters={setFilters} 
                        resetFilters={() => setFilters({ brands: availableBrands, city: "", district: "", zip: "", road: "" })} 
                        matchingStores={matchingStores} onSelectStore={(id) => { const s = allStores.find(x=>x.id===id); if(s) setCenterStore(s); if(window.innerWidth < 1024) setSidebarOpen(false); }} 
                        onImportData={handleImportData}
                        cities={dynamicCities} districtsMap={dynamicDistrictsMap} roadsMap={dynamicRoadsMap} zipsMap={dynamicZipsMap} availableBrands={availableBrands}
                    />
                    <main className="flex-1 pt-16 flex flex-col" style={mainStyle}>
                        {layout.map && <div className="w-full h-[50vh] min-h-[400px] relative shadow-sm z-0"><MapArea displayData={displayData} centerStore={centerStore} onStoreSelect={(s) => setCenterStore(s)} compRadius={compRadius} lang={lang} /></div>}
                        {layout.info && (
                            <div className="w-full max-w-6xl mx-auto p-4 md:p-6 grid grid-cols-1 md:grid-cols-2 gap-8 items-start fade-in">
                                <div className="flex flex-col gap-4">
                                    <div className="flex flex-col gap-2">
                                        <h3 className="font-bold text-bcg-green text-sm uppercase tracking-widest flex items-center gap-2"><i className="fas fa-crosshairs"></i> {t.targetStore}</h3>
                                        {centerStore ? <div className="w-full max-w-md shadow-lg rounded-lg overflow-hidden border border-emerald-100"><StoreDetail store={centerStore} isTarget={true} lang={lang} /></div> : <div className="p-8 border-2 border-dashed border-slate-200 rounded-lg text-slate-400 text-center italic">{t.noStoreSelected}</div>}
                                    </div>
                                    {centerStore && <div className="grid grid-cols-2 gap-4"><FlipCard title={t.flip1_title} content={t.flip1_content} /><FlipCard title={t.flip2_title} content={t.flip2_content} /></div>}
                                </div>
                                <div className="flex flex-col gap-4">
                                    <div className="flex flex-col sm:flex-row sm:items-end gap-4 justify-between border-b border-slate-200 pb-4">
                                        <div><h3 className="font-bold text-slate-500 text-sm uppercase tracking-widest flex items-center gap-2"><i className="fas fa-users"></i> {t.competitors}{isAnalyzing && <i className="fas fa-circle-notch fa-spin text-bcg-green ml-2"></i>}</h3><p className="text-xs text-slate-400 mt-1">{competitors.length} stores found</p></div>
                                        <div className="flex flex-col items-end gap-1"><label className="text-[10px] font-bold text-slate-400 uppercase">{t.radius}</label><div className="flex bg-white border border-slate-300 rounded overflow-hidden">{[50, 100, 500].map(r => (<button key={r} onClick={() => setCompRadius(r)} className={`px-3 py-1 text-xs font-bold transition-colors ${compRadius === r ? 'bg-bcg-green text-white' : 'text-slate-500 hover:bg-slate-50'}`}>{t[`radius_${r}`] || r}</button>))}</div></div>
                                    </div>
                                    <div className="w-full">
                                        <select className="w-full p-2.5 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 text-sm outline-none focus:ring-2 focus:ring-bcg-green cursor-pointer" value={selectedCompId} onChange={(e) => setSelectedCompId(e.target.value)} disabled={!centerStore || competitors.length === 0}>
                                            <option value="">{competitors.length > 0 ? t.select_comp_default : t.none}</option>
                                            {competitors.map((c) => (<option key={c.id} value={c.id}>{c.brand} - {lang === 'en' ? c.name.en : c.name.tw} ({Math.round(c.distance)}m)</option>))}
                                        </select>
                                    </div>
                                    {selectedCompId && (() => { const comp = competitors.find(c => c.id.toString() === selectedCompId.toString()); if (!comp) return null; return <div className="w-full max-w-md shadow-md rounded-lg overflow-hidden fade-in border border-slate-200"><StoreDetail store={comp} isTarget={false} lang={lang} /></div>; })()}
                                    {centerStore && <Dashboard sci={indices.sci} cci={indices.cci} t={t} />}
                                </div>
                            </div>
                        )}
                        <Footer t={t} />
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>